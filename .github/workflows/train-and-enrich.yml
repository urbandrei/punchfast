name: Train & Enrich on stores.json changes

on:
  # Manual trigger from the Actions tab
  workflow_dispatch:
    inputs:
      scrape:
        description: "Scrape websites during enrichment (polite & slower)"
        required: false
        default: "false"
  # Auto-trigger when data or code changes
  push:
    paths:
      - "ai/data/stores.json"            # if you commit the ai/data file directly
      - "stores.json"                    # if you keep the canonical file at repo root
      - "ai/src/**"                      # pipeline code changes
      - "requirements.txt"               # deps changes
      - ".github/workflows/train-and-enrich.yml"

permissions:
  contents: write   # allow the workflow to commit models + enriched JSON back

concurrency:
  group: train-enrich
  cancel-in-progress: false

jobs:
  train-enrich:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure data path
        run: |
          # keep a canonical copy under ai/data for training
          mkdir -p ai/data ai/models ai/data/processed
          if [ -f "stores.json" ]; then cp stores.json ai/data/stores.json; fi
          test -f ai/data/stores.json || (echo "ai/data/stores.json missing" && exit 1)

      - name: Build training data
        run: |
          python ai/src/build_training.py --input ai/data/stores.json --out ai/data/processed

      - name: Train store-type model
        run: |
          python ai/src/train_type.py --data ai/data/processed --out ai/models

      - name: Train cuisine model (multi-label)
        run: |
          python ai/src/train_cuisine.py --data ai/data/processed --out ai/models

      - name: Enrich stores (predict missing labels)
        env:
          SCRAPE_INPUT: ${{ github.event.inputs.scrape }}
        run: |
          if [ "${SCRAPE_INPUT}" = "true" ]; then
            python ai/src/enrich.py --stores ai/data/stores.json --models ai/models --out ai/data/stores_enriched.json --scrape
          else
            python ai/src/enrich.py --stores ai/data/stores.json --models ai/models --out ai/data/stores_enriched.json
          fi
          test -f ai/data/stores_enriched.json

      - name: Upload artifacts (download from the run page)
        uses: actions/upload-artifact@v4
        with:
          name: trained-models-and-enriched-data
          path: |
            ai/models/**
            ai/data/stores_enriched.json

      - name: Commit & push results
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A ai/models ai/data/stores_enriched.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "CI: retrain and update stores_enriched.json [skip ci]"
            git push
          fi
