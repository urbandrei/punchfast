'use strict';

module.exports = {
  async up(queryInterface, Sequelize) {
    // Add in_route column to Stores table
    await queryInterface.addColumn('Stores', 'in_route', {
      type: Sequelize.BOOLEAN,
      allowNull: false,
      defaultValue: false
    });

    // Backfill existing stores that are in auto-generated routes
    await queryInterface.sequelize.query(`
      UPDATE "Stores"
      SET in_route = true
      WHERE id IN (
        SELECT DISTINCT rs."storeId"
        FROM "RouteStores" rs
        INNER JOIN "Routes" r ON rs."routeId" = r.id
        WHERE r."isAutoGenerated" = true
      )
    `);
  },

  async down(queryInterface, Sequelize) {
    await queryInterface.removeColumn('Stores', 'in_route');
  }
};
